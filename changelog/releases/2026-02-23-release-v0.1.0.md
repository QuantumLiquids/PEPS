# Release v0.1.0

**Date**: 2026-02-23
**Type**: Release
**Status**: COMPLETED
**Git range**: `v0.0.3..v0.1.0` 

## Highlights

- **L-BFGS optimizer**: New quasi-Newton optimizer with two step-length modes — fixed-step (suited for stochastic/MC evaluation) and strong-Wolfe line search (suited for deterministic/exact summation). Includes curvature damping, direction norm capping, and optional fallback. Factory helpers: `OptimizerFactory::CreateLBFGS()` and `CreateLBFGSAdvanced()`.
- **Loop update overhaul**: PBC support (even-sized lattices), complex tensor support, refactored `LoopUpdatePara` executor API with `LoopGateType` enum, advanced multi-criterion convergence stop, and per-step observability (step observer callback + machine-readable `LU_METRIC` output).
- **Simple update observability & auto-stop**: Machine-readable `SU_METRIC` per-step output, step observer callbacks, and multi-criterion automatic convergence detector (energy + lambda drift + bond stability + patience).
- **Spike recovery & checkpointing**: 4-stage EMA-based anomaly detection (S1: error bar spike, S2: gradient norm spike, S3: natural gradient anomaly, S4: energy spike upward) with resample/rollback recovery actions in the VMC optimizer. Periodic TPS checkpointing with full state snapshots.
- **Fermionic VMC/SR math self-consistency**: Per-sample O\*=Pi(R\*) construction at sample time, eliminating delayed parity transforms. SR and gradient buffers now directly consume physical O\* tensors.
- **TRG performance**: Split cache flattened from per-slot to per-node (50% memory reduction), batch hole computation via `PunchAllHoles()`, optimized 3x3 terminal contraction memory, consolidated SVD and RG propagation code.
- **Versioning surface established**: Added repository root `VERSION` (`0.1.0`), declared `project(... VERSION 0.1.0)` in CMake, and exposed public `qlpeps/version.h` macros (`QLPEPS_VERSION_MAJOR`, `QLPEPS_VERSION_MINOR`, `QLPEPS_VERSION_PATCH`, `QLPEPS_VERSION`) via `qlpeps/qlpeps.h`.

## Breaking Changes

1. **`MonteCarloParams::num_samples` renamed to `total_samples`**
   - The field now represents the **total** sample budget across all MPI ranks (previously it was per-rank).
   - The engine internally computes per-rank counts via `SamplesPerRank()`.
   - Migration: replace `params.num_samples` with `params.total_samples`. The deprecated `num_samples()` accessor is still available temporarily.

## Bug Fixes

- **Restore accept-rate and middle-row correlation outputs**: Accept-rate propagation and Heisenberg middle-row off-diagonal correlation exports (`SmSp_row`, `SpSm_row`) were accidentally dropped and are now restored with observable metadata and test coverage.

## New Features

### L-BFGS Optimizer
- Two step-length modes via `LBFGSStepMode`: `kFixed` (default, no line search) and `kStrongWolfe` (curvature-checked line search).
- 14 tunable parameters in `LBFGSParams`: history size, Wolfe constants, step bounds, curvature thresholds, damping, direction capping, fallback policy.
- MPI-aware: strong-Wolfe broadcasts search direction for coordinated evaluation; history maintained on master rank only.
- Spike recovery aware: RESAMPLE preserves L-BFGS history; ROLLBACK restores one-step snapshot (state, gradient, history).

### Loop Update
- **PBC support**: Automatic boundary detection and plaquette indexing for periodic lattices. Requires even Lx and Ly (fail-fast validation at construction).
- **Complex tensor support**: Phase-robust power-method convergence (`|overlap| ~ 1`), mixed-type Contract fixes, `ToComplex()` gauge-fixing conversion.
- **`LoopUpdatePara` struct**: Replaces ad-hoc constructor parameters. `LoopGateType` enum distinguishes first-order (`1 - tau*H`) from exponential (`exp(-tau*H)`) gates with corresponding energy estimators.
- **Advanced convergence stop**: `AdvancedStopConfig` with energy absolute/relative tolerance, lambda relative drift tolerance, patience, and minimum steps. `RunSummary` reports `converged`, `stop_reason`, and `executed_steps`.
- **Per-step observability**: `LoopUpdateStepMetrics` struct with E0, En, truncation error, elapsed time, bond dimension changes. Optional step observer callback and `LU_METRIC` machine-readable stdout lines.

### Simple Update
- **Advanced automatic convergence stop**: Same multi-criterion gate as loop update — energy convergence (hybrid abs/rel tolerance), lambda L2 drift, bond dimension stability, patience + min_steps. Factory: `SimpleUpdatePara::Advanced(...)`.
- **Machine-readable observability**: `SimpleUpdateStepMetrics` struct, step observer callback, `SU_METRIC` stdout lines. `SweepResult` return type from all subclass sweep methods.

### Spike Recovery & Checkpointing
- **4-stage detection**: S1 (error bar spike), S2 (gradient norm spike), S3 (natural gradient anomaly / suspicious CG count), S4 (upward energy spike). EMA-based adaptive thresholds with configurable factors.
- **Recovery actions**: `kResample` (redo MC sampling, configurable max retries), `kRollback` (restore previous accepted state, S4 only), `kAcceptWithWarning`.
- **`SpikeStatistics`** aggregate with event log, accessible via `VMCPEPSOptimizer::GetSpikeStatistics()` and `VmcOptimizeResult::spike_stats`.
- **Periodic checkpointing**: `CheckpointParams` with configurable interval and base path. Saves wavefunction, trajectory, and spike statistics.

### Auto Step Selector
- Two-phase MC-oriented step-size selector: early phase picks lower mean energy ignoring error bars; late phase requires statistically significant improvement (>1 sigma).
- `AutoStepSelectorParams` and `InitialStepSelectorParams` with master switches, trigger intervals, and phase boundaries.
- Line-search logic unified and folded into iterative selector framework.

### CG Solver
- **Unified `CGResult` return type**: Includes solution vector, residual norm, iteration count, and explicit `converged` flag.
- **Absolute tolerance parameter**: New `absolute_tolerance` (default 0.0) provides a floor for residual norm, preventing over-solving when RHS is small. Dual stopping criterion: `||r||^2 <= max(tol * ||b||^2, abs_tol^2)`.

## Improvements

### TRG Contractor Refactoring
- **Split cache flattened**: Per-slot → per-node cache reduces memory 50% and eliminates redundant SVDs per RG layer.
- **Batch hole computation**: `PunchAllHoles()` replaces single-site `PunchHole()` for O(1) redundant top-layer computations.
- **Terminal 3x3 memory optimization**: Reduced peak memory in the final contraction step for 3x2^k lattices.
- **Consolidated SVD & RG propagation**: Unified `SplitNode_()` with `SplitResult` struct and extracted `PropagateReplacements_()` (~160 lines reduction).
- **Topology validation**: `ValidateTopologyConsistency_()` hard-throw check after cache operations.

### Fermionic VMC/SR
- Per-sample O\*=Pi(R\*) construction at sample/config-increment time. SR CG solver no longer wraps pre/post parity transforms — directly consumes physical O\* buffers.
- Golden regression tests: `test_fermion_mc_sr_golden` (MC+SR path) and `test_fermion_exact_optimizer_integration_golden` (exact summation + optimizer path) with fixed-seed golden signatures.

### MPI
- Consolidated MPI warm-up timing output (single-line summary instead of per-rank).
- Clear optimizer/evaluator MPI responsibility separation: single state broadcast per iteration (previously triple redundant).

### Documentation
- **Reorganized into Diataxis structure** (Tutorials / How-to / Explanation / Reference) for both EN and ZH.
- New tutorials: TFIM simple update, VMC optimize, MC measure (EN + ZH).
- New how-to guides: build & link, set optimizer parameters, spike recovery, write custom energy solver, write MC updater.
- New explanations: optimizer algorithms, spike recovery math, VMCPEPSOptimizer architecture, model energy solver math.
- Developer math docs: gradient foundation from geometry, bosonic SR rewrite, fermion VMC math & implementation, expanded exact summation.

## Test Status

- All fast tests (including MPI) pass. Integration tests and slow tests are not in scope for this release and may be addressed in v0.1.x.
- New test files added:
  - `test_loop_update.cpp` / `test_loop_update_observability.cpp`
  - `test_simple_update_advanced_stop.cpp` / `test_simple_update_observability.cpp`
  - `test_fermion_mc_sr_golden.cpp` / `test_fermion_exact_optimizer_integration_golden.cpp`
  - `test_optimizer_lbfgs_exact_sum.cpp` / `test_optimizer_lbfgs_mc_regression.cpp` / `test_optimizer_lbfgs_recovery_policy.cpp`
  - `test_auto_step_selector_policy.cpp` / `test_spike_detection.cpp` / `test_optimizer_params.cpp`
  - `test_monte_carlo_engine.cpp`

## Notes

- **Loop update is experimental**: Loop update convergence tests are disabled by default (slow and unstable). Set `QLPEPS_ENABLE_EXPERIMENTAL_LOOP_UPDATE_TESTS=1` to run them. The loop update module should be considered experimental in this release.
- Singlet pair correlation for t-J remains disabled (same as v0.0.3).
- Spinless fermion loop update test is skipped (pre-existing fermion projection issue).

## References (detailed notes)

- `changelog/releases/2026-01-31-release-v0.0.3.md` (previous release)
