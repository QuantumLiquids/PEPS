## Suwa–Todo 更新核：环上重叠采样（几何法）

目标：给定非负权重 `w[j]`（未必归一），从当前状态 `i` 产生下一个状态，使得转移概率满足几何重叠规则，数学上等价于经典的 `v[j]`-min/max 公式，但数值更稳健、实现更简单。

### 1. 记号与区间布局（一步到位）

- 定义总和与前缀和：
  \[ S = \sum_{j=0}^{n-1} w_j, \quad s_k = \sum_{t=0}^{k} w_t, \; s_{-1}=0. \]
- 在周长为 \(S\) 的圆环（展开为区间 \([0,S)\)）上放置每个目标状态的半开区间：
  \[ I_j = [\, s_{j-1},\; s_j \,). \]
- 预处理（可选但与现代码一致）：把最大权重调到下标 0，并同步重映射 `init_state`；返回前再映回原下标。

### 2. 源区间的构造（避免减法）

- 定义 `s_im1 = (i==0 ? 0 : s[i-1])`，利用恒等式 \(s[i]-w[i]=s[i-1]\) 避免减法。
- 取一个固定偏移常数 `C` 并对所有源区间使用相同的 `C`。为了和“最大权重置于 0”的习惯对应，令 `C = w[0]`。
- 源区间起点：
  \[ \texttt{start} = (\, s_{i-1} + C \,) \bmod S. \]
- 源区间为长度 \(w_i\) 的半开区间：
  \[ J_i = [\, \texttt{start},\; \texttt{start} + w_i \,) \; (\bmod\; S). \]

注：`C` 取任何常数都行（只要所有 `i` 一致），选 `C=w[0]` 是为了与现实现中“对齐 `I_0`”的直觉一致。

### 3. 采样与概率：两种等价实现

实现 A：直接从 \([\texttt{start},\; \texttt{start} + w_i)\) 采样（更直观）

1) 采样 \(u \sim U(0, w_i)\)（半开上界，使用 `std::nextafter(w[i], 0.0)` 作为上界），令 \(x = \texttt{start} + u\)。

2) 环上取模：`x_mod = (x >= S ? x - S : x)`。

3) 用 upper_bound 找 `j`：最小的 `j` 满足 `s[j] > x_mod`，返回 `j`。

4) 若一开始做过“最大权重交换”，在返回前将下标映回原序。

实现 B：区间行走法（数值更稳健，避免显式“大数 + 小数”）

1) 采样 \(u \sim U(0, w_i)\)。

2) 找到 `start` 所在的目标段下标 `p`，即最小的 `p` 满足 `s[p] > start`。

3) 计算 `gap = s[p] - start`。若 `u < gap`，返回 `p`。

4) 否则令 `rem = u - gap`，从 `q = (p+1) % n` 开始沿环前进：若 `rem < w[q]`，返回 `q`；否则 `rem -= w[q]`，`q` 前进，直至命中。

5) 若一开始做过“最大权重交换”，在返回前将下标映回原序。

等价性与选择：两种实现严格等价。实现 A 最直观；当 \(S \gg w_i\) 且担心 `x = start + u` 的加法放大舍入误差时，可选实现 B 以仅用加法与比较完成命中判定。

### 4. 数值与边界

- 半开区间消除边界二义性，概率自动归一，无需断言 `sum(v)==w[i]`。
- 路径仅含加法、比较与一次环绕判断，无“大数减小数”。
- 若担心极端尺度不均衡：只把前缀和 `s[k]` 用 `long double` 计算即可。
- `S=0`（全零）应在上层拒绝；`w[i]` 必须大于 0。

### 5. 与 `v`-min/max 的对比

- 几何法：不构造 `v[j]`，不比较 `sum(v)` 与 `w[i]`，无断言；只做“加法 + 比较 + 环绕”。
- 传统法：`min/max` 折点敏感、含大数减小数，易在极端规模下触发偶发偏差。

### 6. 测试建议

- 归一性：频率近似等于理论重叠长度比。
- 边界：接近 `s[k]` 时无二义性（半开区间保证）。
- 鲁棒性：`w[i] \ll S` 仍稳定；多轮采样无“未命中箱子”。

### 参考

- H. Suwa and S. Todo, “Markov Chain Monte Carlo Method without Detailed Balance,” Phys. Rev. Lett. 105, 120603 (2010).


