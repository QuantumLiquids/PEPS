# 尖峰恢复数学（基于 EMA 的检测）

本页总结 VMC 优化器中尖峰检测与恢复的数学。
假设你已经了解 VMC、SR 与 CG。

## 动机（为什么需要尖峰恢复）

蒙特卡洛估计是随机的。罕见组态或采样不足会导致能量误差条、梯度范数或自然梯度范数出现突然尖峰。
在这些异常点上更新参数会破坏优化稳定性。

尖峰恢复通过对比信号与其近期历史（EMA 统计量）来保护优化器，并在检测到异常时 **重采样** 或 **回滚**。

## EMA 跟踪（指数滑动平均）

EMA（Exponential Moving Average）为每个标量信号跟踪均值与方差。

令 $x_t$ 为第 $t$ 步的标量信号，$w$ 为 `ema_window`。
实现中的 EMA 与方差：

- $\alpha = 2 / (w + 1)$。
- 均值：$m_t = m_{t-1} + \alpha (x_t - m_{t-1})$。
- 方差：$v_t = (1 - \alpha)\,(v_{t-1} + \alpha (x_t - m_{t-1})^2)$。
- 标准差：$\sigma_t = \sqrt{v_t}$。

EMA 统计只在 **接受的步骤** 上更新。

## 信号的 EMA 记号

我们为每个信号维护独立的 EMA 统计量。记号：

- $m_t^{(e)}$：能量误差条 $e_t$ 的 EMA 均值。
- $m_t^{(g)}$：梯度范数 $g_t$ 的 EMA 均值。
- $m_t^{(n)}$：自然梯度范数 $n_t$ 的 EMA 均值。
- $m_t^{(E)}$：能量 $E_t$ 的 EMA 均值。
- $\sigma_t^{(E)}$：能量 $E_t$ 的 EMA 标准差。

## 信号与阈值

### S1：能量误差条尖峰

令 $e_t$ 为能量误差条（MC 误差）。

触发条件：

- $e_t > \kappa_e \cdot m_t^{(e)}$，其中 $\kappa_e$ 是阈值 `factor_err`。

### S2：梯度范数尖峰

令 $g_t = \|\nabla E\|$。

触发条件：

- $g_t > \kappa_g \cdot m_t^{(g)}$，其中 $\kappa_g$ 是阈值 `factor_grad`。

### S3：自然梯度异常（仅 SR）

令 $n_t = \|\nabla_{\text{SR}} E\|$，$k_t$ 为 CG 迭代次数。

触发条件（满足其一）：

- $n_t > \kappa_n \cdot m_t^{(n)}$，其中 $\kappa_n$ 是阈值 `factor_ngrad`，或
- $k_t \le k_{\text{min}}$，其中 $k_{\text{min}}$ 是阈值 `sr_min_iters_suspicious`。

### S4：能量上升尖峰（回滚，需显式开启）

令 $E_t$ 为能量（实部）。

触发条件（同时满足）：

- $E_t$ 相对 EMA 均值上升，且
- $E_t > m_t^{(E)} + \sigma_k \cdot \sigma_t^{(E)}$，其中 `sigma_k` 为阈值系数。

S4 默认关闭，需要手动开启。

## 动作

动作由信号类型与重试预算共同决定：

- **重采样**（S1-S3）：重新进行蒙特卡洛评估（同一步，新的样本）。
- **回滚**（需显式开启）：恢复上一次被接受的状态。
  - S4 开启后总是触发回滚；
  - 也可能在 S1-S3 的重采样重试次数耗尽后作为兜底动作触发
    （当开启回滚且存在上一步状态时）。
- **带警告接受**：当重采样次数耗尽且回滚未开启/不可用时。

重试预算由 `redo_mc_max_retries` 控制。

## 实际影响

- S1-S3 处理 MC 采样与 SR 求解中的随机噪声。
- S4 用于罕见的能量爆涨，但只恢复波函数状态。
  Adam/AdaGrad/SGD 的动量等 **优化器内部累积量不会恢复**。
- 阈值为乘性比例，随 EMA 统计量缩放，一旦 EMA 稳定后通常较为稳健。

## 相关阅读

- 如何配置：`../howto/spike_recovery.md`
- 优化器设置：`../howto/set_optimizer_parameter.md`
